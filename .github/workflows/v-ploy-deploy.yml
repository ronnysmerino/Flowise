name: Deploy to V-Ploy

on:
  push:
    branches: [ "main", "master" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      deployments: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: |
          if [ -f "yarn.lock" ]; then
            npm install -g yarn
            yarn install --frozen-lockfile
          elif [ -f "pnpm-lock.yaml" ]; then
            npm install -g pnpm
            pnpm install --frozen-lockfile
          elif [ -f "package-lock.json" ]; then
            npm ci
          else
            npm install
          fi

      - name: Build Project
        run: npm run build

      - name: Detect Build Output
        id: detect_output
        run: |
          if [ -d "dist" ]; then
            echo "BUILD_DIR=dist" >> $GITHUB_ENV
          elif [ -d "build" ]; then
            echo "BUILD_DIR=build" >> $GITHUB_ENV
          elif [ -d "out" ]; then
            echo "BUILD_DIR=out" >> $GITHUB_ENV
          else
            echo "Root build folder not found. Searching for index.html..."
            # Find index.html up to 4 levels deep, excluding node_modules
            HTML_FILE=$(find . -maxdepth 4 -name "index.html" -not -path "*/node_modules/*" -not -path "*/public/*" | head -n 1)
            
            if [ -n "$HTML_FILE" ]; then
              DIR=$(dirname "$HTML_FILE")
              # Remove leading ./ if present
              CLEAN_DIR=${DIR#./}
              echo "Found index.html in $CLEAN_DIR"
              echo "BUILD_DIR=$CLEAN_DIR" >> $GITHUB_ENV
            else
              echo "Could not detect build output directory. Defaulting to dist"
              echo "BUILD_DIR=dist" >> $GITHUB_ENV
            fi
          fi

      - name: Clean Build Output
        run: |
          echo "Removing node_modules from build directory: $BUILD_DIR"
          find "$BUILD_DIR" -type d -name "node_modules" -exec rm -rf {} + 2>/dev/null || true
          echo "Cleanup complete."

      - name: Upload to R2
        uses: ryand56/r2-upload-action@latest
        with:
          r2-account-id: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          r2-access-key-id: ${{ secrets.R2_ACCESS_KEY_ID }}
          r2-secret-access-key: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          r2-bucket: ${{ secrets.R2_BUCKET_NAME }}
          source-dir: ${{ env.BUILD_DIR }}
          destination-dir: deployments/flowise-8f48a3f3/${{ github.sha }}

      - name: Update V-Ploy Deployment
        run: |
          curl -X POST             -H "Authorization: Bearer ${{ secrets.VPLOY_API_TOKEN }}"             -H "Content-Type: application/json"             -d '{"projectId": "flowise-8f48a3f3", "deploymentId": "${{ github.sha }}"}'             https://v-ploy.com/api/deploy/github-callback
